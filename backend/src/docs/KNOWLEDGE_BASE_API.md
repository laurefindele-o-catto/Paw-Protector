# Knowledge Base API - Postman Guide

## Overview
This API allows you to import the structured veterinary knowledge base into your vector database for RAG (Retrieval-Augmented Generation) capabilities.

## Endpoints

### 1. Get Knowledge Base Statistics
**GET** `/api/knowledge-base/stats`

Preview what will be imported without actually importing.

**Response Example:**
```json
{
  "success": true,
  "statistics": {
    "total_chunks": 38,
    "by_doc_type": {
      "first_aid": 9,
      "disease_guide": 29
    },
    "by_category": {
      "bleeding_control": 1,
      "neurological_emergency": 1,
      "poisoning_toxicity": 1,
      "gastrointestinal_cats": 12,
      "fecal_abnormalities": 23
    },
    "by_severity": {
      "emergency": 9,
      "acute": 5,
      "chronic": 3,
      "informational": 21
    },
    "by_species": {
      "both": 25,
      "cat": 13
    },
    "sample_topics": [...]
  }
}
```

---

### 2. Import Knowledge Base
**POST** `/api/knowledge-base/import`

Import and embed all knowledge base chunks into the vector database.

**What it does:**
- Parses `vector_embedding_file_structured.md`
- Extracts all sections with metadata
- Automatically generates embeddings using OpenAI
- Inserts into PostgreSQL vector database
- Makes content searchable via RAG

**Response Example:**
```json
{
  "success": true,
  "message": "Knowledge base imported and embedded successfully",
  "inserted": 38,
  "statistics": {
    "total_chunks": 38,
    "by_doc_type": {
      "first_aid": 9,
      "disease_guide": 29
    },
    "by_category": {
      "bleeding_control": 1,
      "neurological_emergency": 1,
      "poisoning_toxicity": 1,
      "gastrointestinal_cats": 12,
      "fecal_abnormalities": 23
    },
    "by_severity": {
      "emergency": 9,
      "acute": 5,
      "chronic": 3,
      "informational": 21
    },
    "by_species": {
      "both": 25,
      "cat": 13
    }
  },
  "sample_doc_ids": [
    "kb_first_aid_bleeding_control_a7f3c2d1",
    "kb_first_aid_neurological_emergency_b4e9f8a2",
    "kb_first_aid_poisoning_toxicity_c1d6e3f9",
    "kb_first_aid_dehydration_d8a2b5c7",
    "kb_first_aid_heat_emergency_e3f1c9d4"
  ]
}
```

---

### 3. Re-import Knowledge Base
**POST** `/api/knowledge-base/reimport`

Same as import, but designed for refreshing the knowledge base with updated content.

---

## How to Use in Postman

### Step 1: Check Statistics (Optional)
```
GET http://localhost:3000/api/knowledge-base/stats
```
This shows you what will be imported without actually importing.

### Step 2: Import Knowledge Base
```
POST http://localhost:3000/api/knowledge-base/import
```
No body required. This will:
1. Read the structured markdown file
2. Parse all sections
3. Generate embeddings (may take 30-60 seconds)
4. Insert into database

### Step 3: Verify Import
After import, you can verify by:
- Checking the response statistics
- Testing RAG search via your existing `/api/chat` endpoint
- Querying the database directly

---

## Database Storage

The knowledge base is stored with:
- `user_id`: 0 (indicates global knowledge base)
- `pet_id`: null (not pet-specific)
- `doc_type`: "first_aid" or "disease_guide"
- `metadata`: Contains category, topic, species, severity, source

This allows your RAG agent to retrieve relevant medical information when users ask questions.

---

## Testing the Parser (Optional)

Before importing, you can test the parser:
```bash
cd backend/src/utils
node testKnowledgeBaseParser.js
```

This will show you a preview of parsed documents without touching the database.

---

## Querying the Knowledge Base

After import, your existing RAG search tool will automatically include knowledge base content:

```javascript
// In your agent/chat flow, the ragSearchTool will now return
// knowledge base content when relevant
ragSearchTool({
  query: "what should I do if my cat is bleeding",
  topK: 6,
  doc_types: ["first_aid"] // Optional: filter by doc_type
})
```

The agent will automatically retrieve relevant first aid or disease information to answer user questions!

---

## Notes

- **First Import**: Takes 30-60 seconds due to embedding generation
- **Re-imports**: Will update existing documents with same doc_id
- **User ID**: Always 0 for global knowledge base
- **Embeddings**: Automatically generated by OpenAI text-embedding-3-small
- **Storage**: PostgreSQL with pgvector extension

---

## Troubleshooting

**Error: "Missing DATABASE_URL"**
- Check your `.env` file has DATABASE_URL configured

**Error: "Failed to import knowledge base"**
- Ensure the markdown file exists at `backend/src/vector_embedding_file_structured.md`
- Check that pgvector extension is enabled in PostgreSQL
- Verify OpenAI API key is set in environment variables

**Import takes too long:**
- Normal for first import (38 chunks Ã— ~2 seconds per embedding)
- Subsequent imports are faster due to caching
